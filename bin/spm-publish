#!/usr/bin/env node

var commander = require('commander');
var spmrc = require('spmrc');
var client = require('spm-client');
var co = require('co');
var spm = require('..');
var file = require('../lib/sdk/file');
var log = require('../lib/utils/log');
require('colorful').colorful();

commander.usage('[options] name');

commander
  .option('--registry <url>', 'registry url of yuan server')
  .option('-f, --force', 'force to publish an exists module')
  .option('-q, --quiet', 'show less logs')
  .option('--tag <tag>', 'publish module with a tag, default: stable')
  .option('--doc <dir>', 'upload docs instead of package')
  .option('--verbose', 'show more logs')
  .option('--no-tarball', 'do not upload a tarball')
  .option('--no-color', 'disable colorful print');

commander.on('--help', function() {
  console.log();
  console.log('  ' + 'Examples:'.to.bold.blue.color);
  console.log();
  console.log('   publish a standard cmd module is simple');
  console.log();
  console.log('   $ ' + 'spm publish'.to.magenta.color);
  console.log();
  console.log('   publish to a specified registry');
  console.log();
  console.log('   $ ' + 'spm publish'.to.magenta.color + ' -r'.to.cyan.color + ' http://spm.alipay.im');
  console.log();
});

commander.parse(process.argv);

// verbose vs quiet
spm.log.config(commander);

var pkg = file.readJSON('package.json');
if (!pkg || !pkg.spm) {
  console.log();
  log.error('miss', 'package.json or "spm" key');
  process.exit(2);
}

console.log();
if (commander.doc) {
  spm.upload(commander, pkg);
} else {
  var registry = commander.registry || spmrc.get('registry') || 'http://spmjs.io';
  client.config({
    registry: registry,
    auth: spmrc.get('auth')
  });
  log.info('publish', process.cwd());
  log.info('target', registry);

  var publish = co(client.publish);

  publish({
    cwd: process.cwd(),
    force: commander.force
  }, function(err, pkg) {
    if (err) {
      if (err.statusCode === 401) {
        return log.error('exit', 'authorization is required. try `spm login`');
      }
      console.log(err.stack);
      return log.error('exit', err.message);
    }
    console.log(JSON.stringify(pkg, null, 2))
    if (pkg.message && pkg.status) {
      log[pkg.status](pkg.status, pkg.message);
    }
    log.info('published', (pkg.name + '@' + pkg.version).to.green.color);
  });
}
